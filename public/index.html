<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>hai!touch Gate</title>
    <meta property="og:title" value="hai!touch Gate" />
    <!-- boilerplate -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <!-- favicons -->
    <link rel="icon" href="../favicon.ico" type="image/x-icon" sizes="16x16" />
    <link rel="icon" href="../favicon-128.png" sizes="128x128" />
    <link rel="icon" href="../favicon-180.png" sizes="180x180" />
    <link rel="icon" href="../favicon-192.png" sizes="192x192" />
    <!-- page metadata -->
    <meta
      name="description"
      content="Control games by hai!touch Studios using your phone, tablet, or computer browser."
    />
    <meta
      property="og:description"
      content="Control games by hai!touch Studios using your phone, tablet, or computer browser."
    />
    <!-- sharable image -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@hai1touch" />
    <meta name="twitter:creator" content="@hai1touch" />
    <meta
      property="og:image"
      content="https://haitouch-9320f.web.app/twitter_card.png"
    />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="628" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:ital,wght@0,400;0,700;1,400;1,700&display=swap"
      rel="stylesheet"
    />
    <style>
      html {
        font-family: "Atkinson Hyperlegible", sans-serif;
      }
    </style>
    <link rel="stylesheet" href="client.css" />
    <script id="confirmLeave">
      window.onbeforeunload = function () {
        return "Are you sure you want to leave/reload this page?";
      };
    </script>
    <script type="module">
// Firebase import
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-app.js";
import {
  getDatabase,
  ref,
  onValue,
  get,
  push,
  update,
  child,
} from "https://www.gstatic.com/firebasejs/9.10.0/firebase-database.js";
import {
  getAuth,
  signInAnonymously,
} from "https://www.gstatic.com/firebasejs/9.10.0/firebase-auth.js";

var ready = false;
const NICKNAME_CHAR_LIMIT = 12;
const STRINGS = {
  connectingToDb: "Connecting to database",
  connectingWait: "Please wait...",
  connectedToDb: "Connected to database",
  connectedPrompt: "Please enter the room code",
  roomCodeRefreshing: "Refreshing list of room codes",
  roomCodeRefreshingWait: "Please wait...",
  roomCodeNotEntered: "Incomplete room code",
  roomCodeInvalid: "Room code must be 4 capital letters.",
  roomNone: "No such room",
  roomPleaseVerify: "Double-check your room code",
  roomError: "Error checking room",
  loadingGameName: "Fetching game name...",
  joinWait: "Please wait...",
  joinRejected: "Your join request was rejected.",
  joinFull: "Sorry, this room is full.",
  fullGameInProgress: "Game in progress. Rejoins only.",
  joinAsPlayer: "Join as player",
  joinAsAudience: "Join as audience",
  buttonJoin: "Join room",
  loadingController: "Loading game-specific controller...",
  buttonJoinSuccess: "Success!",
  disconnectedThanks: "Thank you for playing!",
  disconnected: "Disconnected from server.",
  buttonReload: "Reload",
};

const firebaseConfig = {
  apiKey: "AIzaSyCCQlFqG66ls0jNEeZDqv0F5V4d2l3mIPw",
  authDomain: "haitouch-9320f.firebaseapp.com",
  databaseURL: "https://haitouch-9320f-default-rtdb.firebaseio.com",
  projectId: "haitouch-9320f",
  storageBucket: "haitouch-9320f.appspot.com",
  messagingSenderId: "850603279750",
  appId: "1:850603279750:web:a92cc85981305fe85e5807",
};

window.fb_app = initializeApp(firebaseConfig);
window.fb_db = getDatabase(window.fb_app);
window.fb_dbRef = ref(window.fb_db);
window.rc = "";

const auth = getAuth();
signInAnonymously(auth)
  .then(() => {
    console.log("Signed in anonymously to Firebase Realtime Database.");
    document.getElementById("roomName").innerText = STRINGS.connectedToDb;
    document.getElementById("roomStatus").innerText = STRINGS.connectedPrompt;
    ready = true;
  })
  .catch((error) => {
    console.error(
      "Error signing in anonymously to Firebase Realtime Database.",
      error.code,
      error.message
    );
  });
let roomRef;
let roomCodeList = {};
let roomCodeListInitialized = 0;
let controllerPageName = "";
let roomCanBeJoined = false;
let nicknameIsValid = false;

let myName = localStorage.getItem("name");
if (!myName) {
  myName = "";
  let seed = new Date().valueOf(); // current timestamp in ms
  // this is not actually Base64
  const key =
    "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_";
  // just make shit up using Math.random()
  for (let i = 0; i < 8; i++) {
    myName += key.charAt(Math.floor(Math.random() * 64));
  }
  console.log("New name is:", myName);
  localStorage.setItem("name", myName);
}

function formatRoomCode(text) {
  return text.toUpperCase();
}

let roomCodeRef = ref(window.fb_db, "roomCodes");
function setRoomCodes(snapshot) {
  if (!snapshot.val()) return;
  roomCodeList = snapshot.val();
  roomCodeListInitialized = +(new Date());
  console.log("Room codes updated on", roomCodeListInitialized);
  // in case inputRc is not empty upon page load (browser remembered last room code)
  //validateRoomCode();
  if (window.rc != "") {
    if (!roomExists(window.rc)) {
      // unset section tag because the room is gone
      window.location.hash = "";
    }
  }// document.getElementById("roomClosedBg").style.display = "";
}

function roomExists(roomCode) {
  return roomCodeList[roomCode] == true;
}

function getRoomData(roomCode) {
  roomRef = child(window.fb_dbRef, `rooms/${roomCode}`);
  let promise = new Promise((resolve, reject) => {
    get(roomRef)
      .then((snapshot) => {
        console.log("getRoomData then");
        if (!snapshot.exists()) {
          resolve({ state: -1, name: STRINGS.roomNone }); // room nonexistent; please update room codes list
        }
        let val = snapshot.val();
        controllerPageName = val.controllerName;
        if (val.inProgress === true) {
          resolve({ state: 3, name: val.gameName }); // game already started and can’t join as audience
        }
        if (val.playerCount < val.maxPlayers) {
          resolve({ state: 1, name: val.gameName }); // open for players
        }
        if (val.audienceCount < val.maxAudience) {
          resolve({ state: 2, name: val.gameName }); // open only for audience
        }
        resolve({ state: 0, name: val.gameName }); // room exists, but is full and cannot be joined
      })
      .catch((error) => {
        console.error(error);
        resolve({ state: -1, name: STRINGS.roomError });
      });
  });

  return promise;
}

/* Autofill upon reload */
document.addEventListener("DOMContentLoaded", () => {
  const inputRc = document.getElementById("rc");
  const inputNick = document.getElementById("nick");
  const btnJoin = document.getElementById("btnJoin");
  const joinStatus = document.getElementById("joinStatus");

  var rc = window.location.hash
    .substring(1) // starts with a literal "#"
    .toUpperCase();
  if (/^[A-Z]{4}$/.test(rc)) {
    inputRc.value = rc;
  } else {
    inputRc.value = "";
  }
  fixQuotes(inputNick);
  document.getElementById("roomClosedThanks").innerText =
    STRINGS.disconnectedThanks;
  document.getElementById("roomClosedMessage").innerText =
    STRINGS.disconnected;
  document.querySelector("#roomClosedModal button").innerText =
    STRINGS.buttonReload;
  if (!ready) {
    document.getElementById("roomName").innerText =
      STRINGS.connectingToDb;
    document.getElementById("roomStatus").innerText =
      STRINGS.connectingWait;
    btnJoin.innerText = STRINGS.buttonJoin;
  }

  /* Nickname text field validity display */
  function setNicknameValid(newValue) {
    nicknameIsValid = newValue;
    if (newValue) {
      inputNick.classList.remove("fixThis");
    } else {
      inputNick.classList.add("fixThis");
    }
  }

  /*
Room code input.
If the room code is valid, first check if it's in the list of room codes. Then if it exists, get the current state of the room.
*/
  function validateRoomCode(event) {
    if (!!event && event.isComposing) {
      return;
    }
    roomCanBeJoined = false;
    let rc = inputRc.value.toUpperCase();
    document.querySelector(
      "label[for=rc] + .letterCount"
    ).innerText = `${rc.length}/4`;
    const regex = /^[A-Z]{4}$/;
    if (regex.test(rc)) {
      // valid room code
      btnJoin.disabled = true;
      inputRc.classList.remove("fixThis");
      if (!ready) {
        roomName.innerText = STRINGS.connectingToDb;
        roomStatus.innerText = STRINGS.connectingWait;
        setTimeout(250, validateRoomCode);
        return;
      }
      if (roomCodeListInitialized + 15_000 < +(new Date())) {
        roomName.innerText = STRINGS.roomCodeRefreshing;
        roomStatus.innerText = STRINGS.roomCodeRefreshingWait;
        get(roomCodeRef).then((snapshot) => {
          setRoomCodes(snapshot);
          validateRoomCode(event);
        });
        return;
      }
      if (!roomExists(rc)) {
        roomName.innerText = STRINGS.roomNone;
        roomStatus.innerText = STRINGS.roomPleaseVerify;
        return;
      }
      roomName.innerText = STRINGS.loadingGameName;
      roomStatus.innerText = "...";
      window.rc = rc;
      let roomData = getRoomData(rc);
      console.log(roomData);
      roomData.then((value) => {
        console.log("roomData resolved, value is", value);
        roomName.innerText = value.name;
        switch (value.state) {
          case 0:
            roomStatus.innerText = STRINGS.joinFull;
            roomCanBeJoined = false;
            break;
          case 1:
            roomStatus.innerText = STRINGS.joinAsPlayer;
            roomCanBeJoined = true;
            break;
          case 2:
            roomStatus.innerText = STRINGS.joinAsAudience;
            roomCanBeJoined = true;
            break;
          case 3:
            roomStatus.innerText = STRINGS.fullGameInProgress;
            roomCanBeJoined = false;
            break;
          default:
            roomStatus.innerText = `Unknown status (${value.state})`;
            roomCanBeJoined = false;
        }
        if (roomCanBeJoined) {
          btnJoin.disabled = roomCanBeJoined && nicknameIsValid;
          inputNick.focus();
          // set cursor position after the name so that the player can reset it
          inputNick.setSelectionRange(
            inputNick.value.length,
            inputNick.value.length
          );
        }
      });
    } else {
      btnJoin.disabled = true;
      inputRc.classList.add("fixThis");
      roomName.innerText = STRINGS.roomCodeNotEntered;
      roomStatus.innerText = STRINGS.roomCodeInvalid;
    }
  }
  inputRc.addEventListener("input", validateRoomCode);
  /*
Join request!
*/
  function joinRoom() {
    if (!(roomCanBeJoined && nicknameIsValid)) {
      return;
    }
    btnJoin.disabled = true;
    console.log("Joining");
    btnJoin.innerText = STRINGS.joinWait;
    // write own username into 'pending', then listen for it to be removed after it being processed
    let joinRef = child(roomRef, `pending/${myName}`);
    update(joinRef, { status: 1, nick: inputNick.value, uuid: myName });
    onValue(joinRef, (snapshot) => {
      let val = snapshot.val();
      console.log("joinRoom val", val);
      if (val.status === 1) {
        // no change
        return;
      }
      if (val.status == -1) {
        console.log("join rejected");
        btnJoin.disabled = false;
        joinStatus.innerText = STRINGS.joinRejected;
        btnJoin.innerText = STRINGS.buttonJoin;
      } else {
        window.isAudience = val.status == 9;
        console.log("join permitted");
        joinStatus.innerText = STRINGS.loadingController;
        btnJoin.innerText = STRINGS.buttonJoinSuccess;
        replacePage();
      }
    });
  }

  btnJoin.addEventListener("click", joinRoom);

  function inputNickValidation(event) {
    if (!!event && event.isComposing) {
      return;
    }
    fixQuotes(inputNick);
    // Check against the name regex
    var nameRegex = RegExp(
      "^[ !',-./0-9?A-Za-z]{0," + NICKNAME_CHAR_LIMIT + "}$"
    );
    if (nameRegex.test(inputNick.value)) {
      // Valid nick, allow join and save for later
      setNicknameValid(true);
      localStorage.setItem("nickname", inputNick.value);
      console.log(inputNick.value, "is valid");
    } else {
      // Not a valid nick, don't allow join
      setNicknameValid(false);
      console.log(inputNick.value, "is invalid");
    }
    btnJoin.disabled = !(roomCanBeJoined && nicknameIsValid);
  }
  inputNick.addEventListener("input", inputNickValidation);

  // Let the player press Enter after entering their nickname to insta-join
  inputNick.addEventListener("keypress", (e) => {
    if (e.key === "Enter" && btnJoin.disabled === false) {
      joinRoom();
    }
  });
});

/*
Nickname input.
Pass the input element.
If the nickname contains curly Unicode single quotes,
replace them with the allowed typewriter/ASCII single quotes.
*/
function fixQuotes(el) {
  // replace unicode single quotes
  var start = el.selectionStart;
  var end = el.selectionEnd;
  const quotes = /[\u2018\u2019\u201b]/g;
  el.value = el.value.replaceAll(quotes, "'");
  el.value = el.value.replaceAll("\u201a", ",");
  el.value = el.value.toUpperCase();
  //console.log("Fixed quotes:", el.value);
  el.setSelectionRange(start, end);
  document.querySelector(
    "label[for=nick] + .letterCount"
  ).innerText = `${el.value.length}/${NICKNAME_CHAR_LIMIT}`;
}

// Once you join, replace the page's contents with the specified controller
function replacePage() {
  // set section tag to make rejoining easier
  window.location.hash = window.rc;
  // fetch the controller file
  var xmlHttp = new XMLHttpRequest();
  xmlHttp.onreadystatechange = () => {
    if (xmlHttp.readyState == 4) {
      if (xmlHttp.status == 200) {
      //console.log(xmlHttp.responseText);
      // manually extract the element div.game using specific comments
      // this is pretty janky, so if you're looking at this, don't do this for your own projects
      let header = "<!--START INJECTED HTML-->";
      let start = xmlHttp.responseText.indexOf(header) + header.length;
      let end = xmlHttp.responseText.indexOf("<!--END INJECTED HTML-->");
      let htmlText = xmlHttp.responseText.substring(start, end);
      let disconnectedModal = document.getElementById("roomClosedBg");
      document.body.innerHTML = htmlText;
      document.body.appendChild(disconnectedModal);
      // manually extract the element script using specific comments
      // again, this is janky and I do not recommend doing this
      header = "/** START INJECTED SCRIPT **/";
      start = xmlHttp.responseText.indexOf(header) + header.length;
      end = xmlHttp.responseText.indexOf("/** END INJECTED SCRIPT **/");
      let jsText = xmlHttp.responseText.substring(start, end);
      let scriptEl = document.createElement("script");
      scriptEl.innerHTML = jsText;
      scriptEl.type = "module";
      document.head.appendChild(scriptEl);
      // setInterval(heartbeat, 1000);
    } else {
      joinStatus.innerText = "Error downloading controller.";
    }
  };
  xmlHttp.open(
    "GET",
    "https://" +
      window.location.hostname +
      "/controller/" +
      controllerPageName +
      ".html",
    true
  );
  xmlHttp.send(null);
}

// Finally, hide the disconnect overlay
document.getElementById("roomClosedBg").style.display = "none";
    </script>
  </head>

  <body>
    <div id="roomClosedBg">
      <div id="roomClosedModal">
        <div id="roomClosedThanks"></div>
        <div id="handBox">
          <svg
            id="handImage"
            xmlns="http://www.w3.org/2000/svg"
            viewbox="0 0 128 128"
            xmlns:v="https://vecta.io/nano"
          >
            <path
              d="M50.366 1.597C56.08.151 62.779 2.933 63.908 11.647l.188 1.381c-.369-14.241 20.88-14.269 20.867-1.44-.019 19.992 1.403 37.425 5.824 55.67l3.986 38.801c-7.921 1.918-16.33 3.084-29.94 7.108-20.076 5.939-26.631-16.508-35.199-36.693-4.956-11.675-11.206-22.805-17.188-31.359-7.99-11.421 5.441-21.345 13.505-13.534l-.068-.122C16.647 15.681 36.25 6.352 43.193 18.239l-.461-1.318c-2.808-8.206 1.92-13.877 7.635-15.324z"
              fill="#6594e5"
              paint-order="stroke fill markers"
            />
            <path
              d="M88.3 67.861c-4.421-18.245-6.521-35.557-7.19-55.34-.284-8.409-14.951-7.973-13.486.954 2.628 15.989 5.361 28.614 7.108 41.869l-5.187.336c-3.459-13.231-6.676-29.935-8.934-44.392C58.882.24 41.962 3.675 45.672 15.199c4.051 12.586 9.832 29.143 11.935 42.454l-4.199 1.426c-4.656-11.458-8.87-23.478-11.844-35.757-2.84-11.726-20.7-4.755-13.193 7.534 6.728 11.014 10.423 22.734 15.333 33.45l-3.755 2.029c-4.147-7.946-9.49-18.942-12.688-27.773-4.367-12.061-17.99-4.35-11.511 5.75 5.638 8.786 11.416 19.885 16.371 31.559 8.568 20.185 16.607 39.393 32.106 34.809 13.611-4.026 22.022-5.192 29.942-7.11"
              fill="#c8f3ff"
              paint-order="stroke fill markers"
            />
            <path
              d="M108.474 34.899c-10.783-7.508-26.476-.671-19.391 27.975-15.919-4.239-31.056 15.994-22.261 28.671 8.488 12.231 23.579 15.574 27.951 14.513 20.166-4.885 11.508-46.194 13.701-71.16z"
              fill="#6594e5"
              paint-order="stroke fill markers"
            />
            <path
              d="M104.778 36.951c-11.978-7.074-17.352 5.361-11.293 29.773-15.919-4.239-29.905 11.439-26.663 24.822s13.828 15.301 27.348 12.026c18.3-4.433 8.415-41.654 10.608-66.621z"
              fill="#c8f3ff"
              paint-order="stroke fill markers"
            />
            <path
              d="M10.153 52.875c-5.933 10.276 0 37.189 19.771 40.955-10.356-7.69-19.928-23.694-19.77-40.955z"
              fill="#ffc2ee"
              paint-order="stroke markers fill"
            />
            <path
              d="M3.255 76.033c-3.22 7.77 3.601 24.25 19.846 22.962-8.007-3.158-16.952-11.811-19.846-22.962z"
              fill="#f63886"
              paint-order="stroke markers fill"
            />
            <path
              d="M95.796 5.877c11.462 3.071 26.296 26.296 14.979 42.94 1.886-12.76-2.663-30.846-14.98-42.94z"
              fill="#ffc2ee"
              paint-order="stroke markers fill"
            />
            <path
              d="M111.767 8.695c8.317 1.255 18.908 15.606 9.415 28.853 1.431-8.489-1.36-20.617-9.415-28.853z"
              fill="#f63886"
              paint-order="stroke markers fill"
            />
          </svg>
        </div>
        <div id="roomClosedMessage">Disconnected from server.</div>
        <button type="button" onclick="location.reload()">Reload page</button>
      </div>
    </div>
    <header>
      <img id="logo" src="img/haitouch_logo_wide.svg" />
    </header>
    <div id="main">
      <div id="join">
        <div class="letterCountSplit">
          <label for="rc">Room code</label>
          <span class="letterCount">0/4</span>
        </div>
        <input
          style="text-transform: uppercase"
          name="rc"
          id="rc"
          type="text"
          title="4 capital letters."
          placeholder="ABCD"
        />
        <div id="roomName"></div>
        <div id="roomStatus"></div>
        <div class="letterCountSplit">
          <label for="nick">Nickname <i>(optional)</i></label>
          <span class="letterCount">0/12</span>
        </div>
        <input
          style="text-transform: uppercase"
          name="nick"
          id="nick"
          type="text"
          title="Up to 12 letters, numbers, and limited symbols: !',-./?"
          placeholder="PLAYER"
        />
        <div id="joinStatus"></div>
        <button id="btnJoin" disabled></button>
        <div id="finePrint">
          By clicking “Join room”, you agree to our
          <a href="https://haitouch.ga/tos">Terms of Service</a>.<br />
          Created by <a href="https://haitouch.ga">hai!touch Studios</a> as
          <a href="https://github.com/JapanYoshi/haitouch-firebase"
            >free and open-source software</a
          ><br />
          Powered by
          <a href="https://firebase.google.com">Firebase Realtime Database</a>
        </div>
      </div>
    </div>
  </body>
</html>
